<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestión de Clientes y Arriendos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .table-wrapper {
            overflow-x: auto;
        }

        .form-control, .btn {
            border-radius: 0.5rem;
        }

        .btn {
            font-weight: 600;
        }

        .form-section {
            background: #fff;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <h2 class="mb-4">Gestión de Clientes</h2>

        <!-- Formulario -->
        <div class="form-section row g-3">
            <input type="hidden" id="ID_CLIENTE">
            <div class="col-md-4"><input class="form-control" id="IDENTIFICACION" placeholder="Identificación"></div>
            <div class="col-md-4"><input class="form-control" id="NOMBRES" placeholder="Nombres"></div>
            <div class="col-md-4"><input class="form-control" id="APELLIDOS" placeholder="Apellidos"></div>
            <div class="col-md-4"><input class="form-control" id="TELEFONO" placeholder="Teléfono"></div>
            <div class="col-md-4"><input class="form-control" id="EMAIL" placeholder="Correo"></div>
            <div class="col-md-4"><input class="form-control" id="DIRECCION" placeholder="Dirección"></div>
            <div class="col-12 text-center">
                <button class="btn btn-success me-2" onclick="guardarCliente()">Insertar</button>
                <button class="btn btn-primary me-2" onclick="actualizarCliente()">Actualizar</button>
                <button class="btn btn-danger" onclick="eliminarCliente()">Eliminar</button>
            </div>
        </div>

        <!-- Tabla de clientes -->
        <div class="table-wrapper">
            <table class="table table-bordered table-hover" id="clientesTable">
                <thead class="table-dark text-center">
                    <tr>
                        <th>ID</th>
                        <th>Identificación</th>
                        <th>Nombre Completo</th>
                        <th>Teléfono</th>
                        <th>Email</th>
                        <th>Dirección</th>
                        <th>Editar</th>
                    </tr>
                </thead>
                <tbody id="clientesBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const apiBase = "https://localhost:44375";
        const headers = {
            "Authorization": `Bearer ${localStorage.getItem("token")}`,
            "Content-Type": "application/json"
        };

        document.addEventListener("DOMContentLoaded", () => {
            cargarClientes();
        });

        function limpiarFormulario() {
            ID_CLIENTE.value = "";
            IDENTIFICACION.value = "";
            NOMBRES.value = "";
            APELLIDOS.value = "";
            TELEFONO.value = "";
            EMAIL.value = "";
            DIRECCION.value = "";
        }

        async function cargarClientes() {
            const res = await fetch(`${apiBase}/api/CLIENTEs/ConsultarTodos`, { headers });
            const clientes = await res.json();
            const tbody = document.getElementById("clientesBody");
            tbody.innerHTML = "";

            clientes.forEach(c => {
                tbody.innerHTML += `
                        <tr>
                            <td>${c.ID_CLIENTE}</td>
                            <td>${c.IDENTIFICACION}</td>
                            <td>${c.NOMBRES} ${c.APELLIDOS}</td>
                            <td>${c.TELEFONO ?? '-'}</td>
                            <td>${c.EMAIL ?? '-'}</td>
                            <td>${c.DIRECCION ?? '-'}</td>
                            <td><button class="btn btn-sm btn-warning" onclick='cargarEdicion(${JSON.stringify(c)})'>Editar</button></td>
                        </tr>`;
            });
        }

        function cargarEdicion(c) {
            ID_CLIENTE.value = c.ID_CLIENTE;
            IDENTIFICACION.value = c.IDENTIFICACION;
            NOMBRES.value = c.NOMBRES;
            APELLIDOS.value = c.APELLIDOS;
            TELEFONO.value = c.TELEFONO;
            EMAIL.value = c.EMAIL;
            DIRECCION.value = c.DIRECCION;
        }

        async function guardarCliente() {
            const cliente = recolectarDatos();
            const res = await fetch(`${apiBase}/api/CLIENTEs/Insertar`, {
                method: "POST",
                headers, body: JSON.stringify(cliente)
            });
            if (res.ok) {
                alert("Cliente insertado");
                limpiarFormulario();
                cargarClientes();
            } else {
                alert(await res.text());
            }
        }

        async function actualizarCliente() {
            const cliente = recolectarDatos();
            if (!cliente.ID_CLIENTE) return alert("Seleccione un cliente para actualizar.");
            const res = await fetch(`${apiBase}/api/CLIENTEs/Actualizar`, {
                method: "PUT",
                headers, body: JSON.stringify(cliente)
            });
            if (res.ok) {
                alert("Cliente actualizado");
                limpiarFormulario();
                cargarClientes();
            } else {
                alert(await res.text());
            }
        }

        async function eliminarCliente() {
            const id = ID_CLIENTE.value;
            if (!id) return alert("Seleccione un cliente para eliminar.");
            if (!confirm("¿Está seguro que desea eliminar este cliente?")) return;
            const res = await fetch(`${apiBase}/api/CLIENTEs/Eliminar`, {
                method: "DELETE",
                headers, body: JSON.stringify({ ID_CLIENTE: id })
            });
            if (res.ok) {
                alert("Cliente eliminado");
                limpiarFormulario();
                cargarClientes();
            } else {
                alert(await res.text());
            }
        }

        function recolectarDatos() {
            return {
                ID_CLIENTE: parseInt(ID_CLIENTE.value) || 0,
                IDENTIFICACION: IDENTIFICACION.value,
                NOMBRES: NOMBRES.value,
                APELLIDOS: APELLIDOS.value,
                TELEFONO: TELEFONO.value,
                EMAIL: EMAIL.value,
                DIRECCION: DIRECCION.value
            };
        }
    </script>
</body>
</html>
